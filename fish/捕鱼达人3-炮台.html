<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>fish</title>
    <style>
        *{
            margin: 0;
            padding: 0;
        }
        body{
            background: #000;
            text-align: center;
        }
        #c1{
            margin-top: 20px;
            background:url("img/game_bg_2_hd.jpg");
        }
    </style>
    <script src="js/com.js"></script>
    <script src="js/resource.js"></script>
    <script src="js/fish.js"></script>
    <script>
        var CANNON_SIZE=[
            null,
            {w: 74, h: 74},
            {w: 74, h: 76},
            {w: 74, h: 76},
            {w: 74, h: 83},
            {w: 74, h: 85},
            {w: 74, h: 90},
            {w: 74, h: 94}
        ];
        function Cannon(type){
            this.type=type;
            this.x=431;
            this.y=570;
            this.rotate=0;
        }
        Cannon.prototype.draw=function(gd){
            var w=CANNON_SIZE[this.type].w;
            var h=CANNON_SIZE[this.type].h;
            gd.save();
            gd.translate(this.x,this.y);
            gd.rotate(d2a(this.rotate));
            gd.drawImage(JSON['cannon'+this.type],
                    0,0,w,h,
                    -w/2,-h/2,w,h
            );
            gd.restore();
        };
        document.addEventListener('DOMContentLoaded',function(){
            var oC=document.getElementById('c1');
            var gd=oC.getContext('2d');
            var out=50;
            var rule=0.05;
            var direction=[-out,out];
            loadImage(resource,function(){
                var arrFish=[];
                //生成炮
                var c1=new Cannon(7);
                setInterval(function(){
                    gd.clearRect(0,0,oC.width,oC.height);
                    //画炮台
                    gd.drawImage(JSON['bottom'],
                            0,0,765,70,
                            0,532,765,70
                    );
                    //画炮
                    c1.draw(gd);
                    //生成鱼
                    if(Math.random()<rule){
                        direction.sort(function(){
                               return Math.random()-0.5;
                        });
                        if(direction[0]<0){
                            //从屏幕左边生成鱼
                            var f1=new Fish(rnd(1,6));
                            f1.x=0-out;
                            f1.y=rnd(out,oC.height-out);
                            f1.rotate=rnd(-45,45);
                            arrFish.push(f1);
                        }else{
                            //从屏幕右边生成鱼
                            var f1=new Fish(rnd(1,6));
                            f1.x=oC.width+out;
                            f1.y=rnd(out,oC.height-out);
                            f1.rotate=rnd(135,225);
                            arrFish.push(f1);
                        }
                    }
                    //画鱼
                    for(var i=0;i<arrFish.length;i++){
                        arrFish[i].draw(gd);
                    }
                    //鱼的性能优化
                    for(var i=0;i<arrFish.length;i++){
                        if(arrFish[i].x<-out||arrFish[i].x>out+oC.width||arrFish[i].y<-out||arrFish.y>out+oC.height){
                            arrFish.splice(i,1);
                            i--;
                        }
                    }
                },16);
                oC.onclick=function(ev){
                    var x=ev.clientX-oC.offsetLeft- c1.x;
                    var y=c1.y-(ev.clientY-oC.offsetTop);
                    var d=90-a2d(Math.atan2(y,x));
                    c1.rotate=d;
                };
            });
        },false);
    </script>
</head>
<body>
    <canvas id="c1" width="800" height="600"></canvas>
</body>
</html>